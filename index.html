<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>REX Chantier - ielo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* √âcran de connexion */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #2d5f4f 0%, #3a7a63 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        #loginScreen.hidden {
            display: none;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .login-logo {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .login-title {
            font-size: 1.5em;
            color: #2d5f4f;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: #3a7a63;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: #3a7a63;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            background: #2d5f4f;
        }

        .login-btn:active {
            transform: scale(0.98);
        }

        .login-error {
            color: #dc3545;
            margin-top: 15px;
            font-size: 0.9em;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .login-info {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 10px;
            font-size: 0.85em;
            color: #2d5f4f;
        }

        #mainContent {
            display: none;
        }

        #mainContent.visible {
            display: block;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding-bottom: 80px;
        }

        .header {
            background: linear-gradient(135deg, #2d5f4f 0%, #3a7a63 100%);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-subtitle {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            height: 4px;
            border-radius: 2px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-fill {
            background: white;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2d5f4f;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.required label::after {
            content: ' *';
            color: #dc3545;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 0.95em;
        }

        input, textarea, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3a7a63;
            background: white;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .input-group {
            position: relative;
        }

        .input-suffix {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 0.9em;
            pointer-events: none;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .btn-primary {
            background: #3a7a63;
            color: white;
        }

        .btn-primary:active {
            background: #2d5f4f;
            transform: scale(0.98);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-outline {
            background: white;
            border: 2px solid #3a7a63;
            color: #3a7a63;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .photo-zone {
            border: 3px dashed #d0d0d0;
            border-radius: 15px;
            padding: 30px 20px;
            text-align: center;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .photo-zone:active {
            background: #f0f5f3;
            border-color: #3a7a63;
        }

        .photo-zone-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .photo-zone-text {
            font-size: 1.1em;
            color: #333;
            font-weight: 500;
        }

        .photo-zone-hint {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .photo-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 1;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .location-container {
            position: relative;
        }

        .location-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: #3a7a63;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 1.2em;
            cursor: pointer;
        }

        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #3a7a63;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
        }

        .autocomplete-results.show {
            display: block;
        }

        .autocomplete-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .autocomplete-item:active {
            background: #f0f5f3;
        }

        .autocomplete-item-main {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .autocomplete-item-secondary {
            font-size: 0.85em;
            color: #666;
        }

        .map-container {
            width: 100%;
            height: 250px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .map-container.show {
            display: block;
        }

        .info-badge {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
            display: none;
        }

        .info-badge.show {
            display: block;
        }

        .calculated-value {
            background: #f0f5f3;
            border-left: 4px solid #3a7a63;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: 600;
            color: #2d5f4f;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .bottom-bar .btn-group {
            max-width: 800px;
            margin: 0 auto;
            grid-template-columns: 2fr 1fr;
        }

        input[type="file"] {
            display: none;
        }

        .collapsible {
            cursor: pointer;
            user-select: none;
        }

        .collapsible::after {
            content: '‚ñº';
            float: right;
            transition: transform 0.3s ease;
        }

        .collapsible.collapsed::after {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        @media (min-width: 768px) {
            .photo-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 10000;
            display: none;
        }

        .toast.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .voice-btn {
            position: absolute;
            right: 10px;
            bottom: 10px;
            background: #3a7a63;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.3em;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 10;
        }

        .voice-btn:hover {
            background: #2d5f4f;
            transform: scale(1.1);
        }

        .voice-btn:active {
            transform: scale(0.95);
        }

        .voice-btn.listening {
            background: #dc3545;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .density-good {
            background: #d4edda !important;
            border-left: 4px solid #28a745 !important;
            color: #155724 !important;
        }

        .density-bad {
            background: #f8d7da !important;
            border-left: 4px solid #dc3545 !important;
            color: #721c24 !important;
        }
    </style>
</head>
<body>
    <!-- √âcran de connexion -->
    <div id="loginScreen">
        <div class="login-box">
            <div class="login-logo">üåæ</div>
            <h1 class="login-title">REX Chantier ielo</h1>
            <p class="login-subtitle">Connexion requise</p>
            
            <input type="password" 
                   id="passwordInput" 
                   class="login-input" 
                   placeholder="Mot de passe"
                   onkeypress="if(event.key==='Enter') checkPassword()">
            
            <button class="login-btn" onclick="checkPassword()">
                üîì Se connecter
            </button>
            
            <div id="loginError" class="login-error">
                ‚ùå Mot de passe incorrect
            </div>
            
            <div class="login-info">
                üîí Acc√®s r√©serv√© aux collaborateurs ielo
            </div>
        </div>
    </div>

    <!-- Contenu principal (masqu√© par d√©faut) -->
    <div id="mainContent">
    <div class="header">
        <h1>üåæ REX Chantier</h1>
        <div class="header-subtitle">Retour d'exp√©rience - ielo</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <div class="container">
        <form id="rexForm">
            <!-- Section 1: Infos essentielles -->
            <div class="section">
                <div class="section-title">üìã Informations essentielles</div>
                
                <div class="form-group required">
                    <label for="nom_projet">Nom du projet</label>
                    <input type="text" id="nom_projet" name="nom_projet" placeholder="Ex: Maison Dupont, Immeuble Centre-Ville..." required>
                </div>

                <div class="form-group required">
                    <label for="date">Date du chantier</label>
                    <input type="date" id="date" name="date" required>
                </div>

                <div class="form-group required location-container">
                    <label for="lieu">Lieu</label>
                    <input type="text" 
                           id="lieu" 
                           name="lieu" 
                           placeholder="Tapez une adresse..."
                           autocomplete="off"
                           oninput="searchAddress(this.value)"
                           required>
                    <button type="button" class="location-btn" onclick="getCurrentLocation()" title="Ma position">
                        üìç
                    </button>
                    <div id="autocompleteResults" class="autocomplete-results"></div>
                    <div id="locationInfo" class="info-badge"></div>
                </div>

                <div id="mapContainer" class="map-container"></div>

                <div class="form-group">
                    <label for="entreprise">Entreprise accompagn√©e</label>
                    <input type="text" id="entreprise" name="entreprise">
                </div>

                <div class="form-group">
                    <label for="meteo">Conditions m√©t√©o</label>
                    <input type="text" id="meteo" name="meteo" placeholder="Ex: Ensoleill√©, 15¬∞C">
                </div>
            </div>

            <!-- Section 2: Photos -->
            <div class="section">
                <div class="section-title">üì∏ Photos du chantier</div>
                
                <div class="photo-zone" onclick="document.getElementById('photoInput').click()">
                    <div class="photo-zone-icon">üì∑</div>
                    <div class="photo-zone-text">Ajouter des photos</div>
                    <div class="photo-zone-hint">Touchez pour prendre ou importer</div>
                </div>
                <input type="file" id="photoInput" accept="image/*" capture="environment" multiple onchange="handlePhotos(this)">
                
                <div id="photoGrid" class="photo-grid"></div>
            </div>

            <!-- Section 3: Quantit√©s -->
            <div class="section">
                <div class="section-title collapsible" onclick="toggleSection(this)">üìä Quantit√©s et surfaces</div>
                <div class="collapsible-content">
                    <div class="form-group">
                        <label for="quantite_paille">Quantit√© de paille (tonnes)</label>
                        <div class="input-group">
                            <input type="number" step="0.01" id="quantite_paille" name="quantite_paille">
                            <span class="input-suffix">t</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="surfaces">Surfaces √† isoler (m¬≤)</label>
                        <div class="input-group">
                            <input type="number" step="0.01" id="surfaces" name="surfaces">
                            <span class="input-suffix">m¬≤</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 4: Caisson de test -->
            <div class="section">
                <div class="section-title collapsible" onclick="toggleSection(this)">üì¶ Caisson de test</div>
                <div class="collapsible-content">
                    <div class="form-group">
                        <label for="dim_l">Longueur (m)</label>
                        <input type="number" step="0.01" id="dim_l" name="dim_l" oninput="calculateVolume()">
                    </div>

                    <div class="form-group">
                        <label for="dim_w">Largeur (m)</label>
                        <input type="number" step="0.01" id="dim_w" name="dim_w" oninput="calculateVolume()">
                    </div>

                    <div class="form-group">
                        <label for="dim_h">Hauteur (m)</label>
                        <input type="number" step="0.01" id="dim_h" name="dim_h" oninput="calculateVolume()">
                    </div>

                    <div id="volumeResult" class="calculated-value" style="display: none;"></div>

                    <div class="form-group">
                        <label for="masse_insufflee">Masse de paille insuffl√©e (kg)</label>
                        <input type="number" step="0.01" id="masse_insufflee" name="masse_insufflee" oninput="calculateDensity()">
                    </div>

                    <div id="densityResult" class="calculated-value" style="display: none;"></div>
                </div>
            </div>

            <!-- Section 5: Observations -->
            <div class="section">
                <div class="section-title">üí¨ Observations</div>
                
                <div class="form-group">
                    <label for="remarques">Remarques g√©n√©rales</label>
                    <div style="position: relative;">
                        <textarea id="remarques" name="remarques" rows="4" placeholder="Points importants, difficult√©s rencontr√©es..."></textarea>
                        <button type="button" 
                                class="voice-btn" 
                                id="voiceBtn"
                                onclick="toggleVoiceInput()"
                                title="Dict√©e vocale">
                            üé§
                        </button>
                    </div>
                    <div id="voiceStatus" style="display: none; margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 8px; font-size: 0.9em;">
                        üé§ √âcoute en cours... Parlez maintenant
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="bottom-bar">
        <div class="btn-group">
            <button type="button" class="btn btn-primary" onclick="saveForm()">
                üìÑ G√©n√©rer PDF & Upload Drive
            </button>
            <button type="button" class="btn btn-outline" onclick="authenticateGoogleDrive()">
                üîó Connecter Drive
            </button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    </div><!-- Fin mainContent -->

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ============================================
        // SYST√àME D'AUTHENTIFICATION
        // ============================================

        // ‚ö†Ô∏è IMPORTANT : Changez ce mot de passe !
        // Pour plus de s√©curit√©, utilisez un hash SHA-256
        const CORRECT_PASSWORD = "ielo2025"; // ‚Üê CHANGEZ CE MOT DE PASSE

        // Alternative : utiliser des hash SHA-256 pour plus de s√©curit√©
        // G√©n√©rez un hash sur : https://emn178.github.io/online-tools/sha256.html
        // const CORRECT_PASSWORD_HASH = "votre_hash_sha256";

        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const password = input.value;
            const error = document.getElementById('loginError');

            // V√©rification du mot de passe
            if (password === CORRECT_PASSWORD) {
                // Mot de passe correct
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.add('visible');
                
                // Sauvegarder la session (optionnel, expire √† la fermeture du navigateur)
                sessionStorage.setItem('authenticated', 'true');
                
                // Initialiser le formulaire
                updateProgress();
                document.getElementById('date').valueAsDate = new Date();
            } else {
                // Mot de passe incorrect
                error.classList.add('show');
                input.value = '';
                input.style.borderColor = '#dc3545';
                
                // Animation shake
                input.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    input.style.animation = '';
                    input.style.borderColor = '';
                }, 500);
            }
        }

        // V√©rifier si d√©j√† authentifi√© (session en cours)
        window.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('authenticated') === 'true') {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.add('visible');
                updateProgress();
                document.getElementById('date').valueAsDate = new Date();
            }
        });

        // Animation shake pour erreur
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                75% { transform: translateX(10px); }
            }
        `;
        document.head.appendChild(style);

        // ============================================
        // CODE DU FORMULAIRE (suite)
        // ============================================

        let photos = [];
        let map = null;
        let marker = null;
        let locationData = { lat: null, lon: null, address: null };
        let searchTimeout = null;

        // Calculer et afficher la progression
        function updateProgress() {
            const form = document.getElementById('rexForm');
            const inputs = form.querySelectorAll('input[required], textarea[required]');
            let filled = 0;
            
            inputs.forEach(input => {
                if (input.value.trim() !== '') filled++;
            });
            
            const progress = (filled / inputs.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // √âcouter les changements de formulaire
        document.getElementById('rexForm').addEventListener('input', updateProgress);
        document.getElementById('rexForm').addEventListener('change', updateProgress);

        // Toggle section collapsible
        function toggleSection(element) {
            element.classList.toggle('collapsed');
            const content = element.nextElementSibling;
            content.classList.toggle('collapsed');
        }

        // Gestion des photos
        function handlePhotos(input) {
            const files = Array.from(input.files);
            
            files.forEach(file => {
                if (!file.type.startsWith('image/')) {
                    showToast('‚ö†Ô∏è Seules les images sont accept√©es');
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) {
                    showToast('‚ö†Ô∏è Image trop volumineuse (max 10 MB)');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    photos.push(e.target.result);
                    displayPhotos();
                    showToast('‚úÖ Photo ajout√©e');
                };
                reader.readAsDataURL(file);
            });
            
            input.value = '';
        }

        function displayPhotos() {
            const grid = document.getElementById('photoGrid');
            grid.innerHTML = '';
            
            photos.forEach((photo, index) => {
                const item = document.createElement('div');
                item.className = 'photo-item';
                
                const img = document.createElement('img');
                img.src = photo;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'photo-item-remove';
                removeBtn.innerHTML = '√ó';
                removeBtn.onclick = () => {
                    photos.splice(index, 1);
                    displayPhotos();
                    showToast('üóëÔ∏è Photo supprim√©e');
                };
                
                item.appendChild(img);
                item.appendChild(removeBtn);
                grid.appendChild(item);
            });
        }

        // Recherche d'adresse
        async function searchAddress(query) {
            clearTimeout(searchTimeout);
            
            const results = document.getElementById('autocompleteResults');
            
            if (query.length < 3) {
                results.classList.remove('show');
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`,
                        { headers: { 'Accept-Language': 'fr' } }
                    );
                    
                    const data = await response.json();
                    
                    if (data.length > 0) {
                        results.innerHTML = '';
                        data.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'autocomplete-item';
                            div.innerHTML = `
                                <div class="autocomplete-item-main">${item.name || item.display_name.split(',')[0]}</div>
                                <div class="autocomplete-item-secondary">${item.display_name}</div>
                            `;
                            div.onclick = () => selectAddress(item);
                            results.appendChild(div);
                        });
                        results.classList.add('show');
                    }
                } catch (error) {
                    console.error('Erreur recherche:', error);
                }
            }, 300);
        }

        function selectAddress(item) {
            document.getElementById('lieu').value = item.display_name;
            locationData = { lat: parseFloat(item.lat), lon: parseFloat(item.lon), address: item.display_name };
            document.getElementById('autocompleteResults').classList.remove('show');
            
            showLocationInfo();
            showMap(locationData.lat, locationData.lon);
        }

        // G√©olocalisation
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                showToast('‚ö†Ô∏è G√©olocalisation non disponible');
                return;
            }

            showToast('üìç Localisation en cours...');

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`,
                            { headers: { 'Accept-Language': 'fr' } }
                        );
                        const data = await response.json();
                        
                        document.getElementById('lieu').value = data.display_name;
                        locationData = { lat, lon, address: data.display_name };
                        showLocationInfo();
                        showMap(lat, lon);
                        showToast('‚úÖ Position trouv√©e');
                    } catch (error) {
                        showToast('‚ö†Ô∏è Erreur de g√©olocalisation');
                    }
                },
                (error) => {
                    showToast('‚ö†Ô∏è Impossible d\'obtenir la position');
                }
            );
        }

        function showLocationInfo() {
            const info = document.getElementById('locationInfo');
            info.innerHTML = `üìç GPS: ${locationData.lat.toFixed(6)}, ${locationData.lon.toFixed(6)}`;
            info.classList.add('show');
        }

        function showMap(lat, lon) {
            const container = document.getElementById('mapContainer');
            container.classList.add('show');
            
            if (!map) {
                map = L.map('mapContainer').setView([lat, lon], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                marker = L.marker([lat, lon]).addTo(map);
            } else {
                map.setView([lat, lon], 15);
                marker.setLatLng([lat, lon]);
            }
            
            setTimeout(() => map.invalidateSize(), 100);
        }

        // Calculs
        function calculateVolume() {
            const l = parseFloat(document.getElementById('dim_l').value) || 0;
            const w = parseFloat(document.getElementById('dim_w').value) || 0;
            const h = parseFloat(document.getElementById('dim_h').value) || 0;
            
            if (l > 0 && w > 0 && h > 0) {
                const volume = l * w * h;
                const poids = volume * 115;
                
                const result = document.getElementById('volumeResult');
                result.innerHTML = `üìä Volume: ${volume.toFixed(2)} m¬≥ | Poids n√©cessaire: ${poids.toFixed(0)} kg`;
                result.style.display = 'block';
                
                calculateDensity();
            }
        }

        function calculateDensity() {
            const l = parseFloat(document.getElementById('dim_l').value) || 0;
            const w = parseFloat(document.getElementById('dim_w').value) || 0;
            const h = parseFloat(document.getElementById('dim_h').value) || 0;
            const masse = parseFloat(document.getElementById('masse_insufflee').value) || 0;
            
            const volume = l * w * h;
            
            if (volume > 0 && masse > 0) {
                const density = masse / volume;
                const result = document.getElementById('densityResult');
                
                // Code couleur selon la masse volumique
                result.classList.remove('density-good', 'density-bad');
                
                if (density >= 105) {
                    result.classList.add('density-good');
                    result.innerHTML = `‚úÖ Masse volumique: <strong>${density.toFixed(2)} kg/m¬≥</strong> - Conforme (‚â• 105 kg/m¬≥)`;
                } else {
                    result.classList.add('density-bad');
                    result.innerHTML = `‚ö†Ô∏è Masse volumique: <strong>${density.toFixed(2)} kg/m¬≥</strong> - Non conforme (< 105 kg/m¬≥)`;
                }
                
                result.style.display = 'block';
            } else {
                document.getElementById('densityResult').style.display = 'none';
            }
        }

        // ============================================
        // DICT√âE VOCALE
        // ============================================

        let recognition = null;
        let isListening = false;

        // Initialiser la reconnaissance vocale
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'fr-FR';
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = function() {
                isListening = true;
                document.getElementById('voiceBtn').classList.add('listening');
                document.getElementById('voiceStatus').style.display = 'block';
                showToast('üé§ √âcoute activ√©e - Parlez maintenant');
            };

            recognition.onend = function() {
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('listening');
                document.getElementById('voiceStatus').style.display = 'none';
            };

            recognition.onresult = function(event) {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                const textarea = document.getElementById('remarques');
                if (finalTranscript) {
                    // Ajouter le texte final au textarea
                    textarea.value += finalTranscript;
                    showToast('‚úÖ Texte ajout√©');
                }

                // Afficher la transcription interm√©diaire dans le status
                if (interimTranscript) {
                    document.getElementById('voiceStatus').innerHTML = 
                        `üé§ √âcoute en cours: "<em>${interimTranscript}</em>"`;
                }
            };

            recognition.onerror = function(event) {
                console.error('Erreur reconnaissance vocale:', event.error);
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('listening');
                document.getElementById('voiceStatus').style.display = 'none';
                
                let message = '‚ö†Ô∏è Erreur de dict√©e';
                
                switch(event.error) {
                    case 'not-allowed':
                    case 'permission-denied':
                        message = '‚ö†Ô∏è Microphone non autoris√©. Autorisez l\'acc√®s au micro dans les param√®tres du navigateur.';
                        break;
                    case 'no-speech':
                        message = '‚ö†Ô∏è Aucune parole d√©tect√©e. R√©essayez.';
                        break;
                    case 'network':
                        message = '‚ö†Ô∏è Erreur r√©seau. V√©rifiez votre connexion.';
                        break;
                    case 'audio-capture':
                        message = '‚ö†Ô∏è Aucun microphone trouv√©.';
                        break;
                }
                
                showToast(message);
            };
        }

        function toggleVoiceInput() {
            if (!recognition) {
                showToast('‚ö†Ô∏è Dict√©e vocale non disponible sur ce navigateur.\nUtilisez Chrome ou Safari.');
                return;
            }

            if (isListening) {
                recognition.stop();
                showToast('üî¥ Dict√©e arr√™t√©e');
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Erreur d√©marrage reconnaissance:', error);
                    showToast('‚ö†Ô∏è Impossible de d√©marrer la dict√©e');
                }
            }
        }

        // ============================================
        // CONFIGURATION GOOGLE DRIVE
        // ============================================
        
        // ID du dossier Google Drive cible
        const DRIVE_FOLDER_ID = '1to1C4MLfBvp_W5u7sKo7HEqky5o2lUFK';
        
        // Configuration Google API
        const CLIENT_ID = 'VOTRE_CLIENT_ID.apps.googleusercontent.com'; // √Ä configurer
        const API_KEY = 'VOTRE_API_KEY'; // √Ä configurer
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;

        // Charger jsPDF pour g√©n√©rer les PDF
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        document.head.appendChild(script);

        // ============================================
        // G√âN√âRATION DU PDF
        // ============================================

        async function saveForm() {
            showToast('üìÑ G√©n√©ration du PDF en cours...');
            
            // Attendre que jsPDF soit charg√©
            if (typeof window.jspdf === 'undefined') {
                await new Promise(resolve => {
                    const checkjsPDF = setInterval(() => {
                        if (typeof window.jspdf !== 'undefined') {
                            clearInterval(checkjsPDF);
                            resolve();
                        }
                    }, 100);
                });
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // R√©cup√©rer les donn√©es du formulaire
            const formData = new FormData(document.getElementById('rexForm'));
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            let yPos = 20;
            const lineHeight = 7;
            const pageHeight = 280;

            // En-t√™te
            doc.setFontSize(20);
            doc.setTextColor(45, 95, 79);
            doc.text('üåæ REX Chantier - ielo', 105, yPos, { align: 'center' });
            yPos += 15;

            // Date et lieu
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Date: ${data.date || 'Non renseign√©'}`, 20, yPos);
            yPos += lineHeight;
            doc.text(`Lieu: ${data.lieu || 'Non renseign√©'}`, 20, yPos);
            yPos += lineHeight;

            // Coordonn√©es GPS si disponibles
            if (locationData.lat && locationData.lon) {
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`GPS: ${locationData.lat.toFixed(6)}, ${locationData.lon.toFixed(6)}`, 20, yPos);
                yPos += lineHeight;
            }

            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            yPos += 3;

            // Entreprise et m√©t√©o
            if (data.entreprise) {
                doc.text(`Entreprise: ${data.entreprise}`, 20, yPos);
                yPos += lineHeight;
            }
            if (data.meteo) {
                doc.text(`M√©t√©o: ${data.meteo}`, 20, yPos);
                yPos += lineHeight;
            }

            yPos += 5;

            // Section Quantit√©s
            doc.setFontSize(14);
            doc.setTextColor(45, 95, 79);
            doc.text('üìä Quantit√©s et surfaces', 20, yPos);
            yPos += lineHeight + 2;

            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            if (data.quantite_paille) {
                doc.text(`Quantit√© de paille: ${data.quantite_paille} tonnes`, 20, yPos);
                yPos += lineHeight;
            }
            if (data.surfaces) {
                doc.text(`Surfaces √† isoler: ${data.surfaces} m¬≤`, 20, yPos);
                yPos += lineHeight;
            }

            yPos += 5;

            // Section Caisson de test
            if (data.dim_l || data.dim_w || data.dim_h || data.masse_insufflee) {
                doc.setFontSize(14);
                doc.setTextColor(45, 95, 79);
                doc.text('üì¶ Caisson de test', 20, yPos);
                yPos += lineHeight + 2;

                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);

                if (data.dim_l && data.dim_w && data.dim_h) {
                    const volume = parseFloat(data.dim_l) * parseFloat(data.dim_w) * parseFloat(data.dim_h);
                    doc.text(`Dimensions: ${data.dim_l} √ó ${data.dim_w} √ó ${data.dim_h} m`, 20, yPos);
                    yPos += lineHeight;
                    doc.text(`Volume: ${volume.toFixed(2)} m¬≥`, 20, yPos);
                    yPos += lineHeight;
                    doc.text(`Poids n√©cessaire: ${(volume * 115).toFixed(0)} kg`, 20, yPos);
                    yPos += lineHeight;

                    if (data.masse_insufflee) {
                        const density = parseFloat(data.masse_insufflee) / volume;
                        doc.text(`Masse insuffl√©e: ${data.masse_insufflee} kg`, 20, yPos);
                        yPos += lineHeight;

                        // Code couleur pour masse volumique
                        if (density >= 105) {
                            doc.setTextColor(40, 167, 69);
                            doc.text(`‚úì Masse volumique: ${density.toFixed(2)} kg/m¬≥ - CONFORME`, 20, yPos);
                        } else {
                            doc.setTextColor(220, 53, 69);
                            doc.text(`‚úó Masse volumique: ${density.toFixed(2)} kg/m¬≥ - NON CONFORME`, 20, yPos);
                        }
                        doc.setTextColor(0, 0, 0);
                        yPos += lineHeight;
                    }
                }

                yPos += 5;
            }

            // Section Observations
            if (data.remarques) {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFontSize(14);
                doc.setTextColor(45, 95, 79);
                doc.text('üí¨ Observations', 20, yPos);
                yPos += lineHeight + 2;

                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                const remarques = doc.splitTextToSize(data.remarques, 170);
                doc.text(remarques, 20, yPos);
                yPos += remarques.length * lineHeight;
            }

            // Photos
            if (photos.length > 0) {
                doc.addPage();
                yPos = 20;

                doc.setFontSize(14);
                doc.setTextColor(45, 95, 79);
                doc.text('üì∏ Photos du chantier', 105, yPos, { align: 'center' });
                yPos += 15;

                const photosPerPage = 3;
                const photoWidth = 170;
                const photoHeight = 80;

                for (let i = 0; i < photos.length; i++) {
                    if (i > 0 && i % photosPerPage === 0) {
                        doc.addPage();
                        yPos = 20;
                    }

                    try {
                        doc.addImage(photos[i], 'JPEG', 20, yPos, photoWidth, photoHeight);
                        doc.setFontSize(10);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Photo ${i + 1}/${photos.length}`, 105, yPos + photoHeight + 5, { align: 'center' });
                        yPos += photoHeight + 15;
                    } catch (error) {
                        console.error('Erreur ajout photo:', error);
                    }
                }
            }

            // Footer sur toutes les pages
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(9);
                doc.setTextColor(150, 150, 150);
                doc.text(`REX Chantier ielo - Page ${i}/${pageCount}`, 105, 290, { align: 'center' });
                doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}`, 105, 295, { align: 'center' });
            }

            // Nom du fichier
            const fileName = `REX_${data.date || 'chantier'}_${Date.now()}.pdf`;

            // G√©n√©rer le blob PDF
            const pdfBlob = doc.output('blob');

            // T√©l√©chargement local en backup
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);

            showToast('‚úÖ PDF g√©n√©r√© ! Upload vers Drive...');

            // Upload vers Google Drive
            if (accessToken) {
                uploadToGoogleDrive(pdfBlob, fileName);
            } else {
                showToast('‚ö†Ô∏è Connectez-vous √† Google Drive pour l\'upload automatique');
                // Proposer de se connecter
                if (confirm('Voulez-vous vous connecter √† Google Drive pour l\'upload automatique ?')) {
                    authenticateGoogleDrive();
                }
            }
        }

        // ============================================
        // AUTHENTIFICATION GOOGLE DRIVE
        // ============================================

        function authenticateGoogleDrive() {
            showToast('üîê Connexion √† Google Drive...');
            
            // Charger Google Identity Services
            if (!window.google) {
                const script = document.createElement('script');
                script.src = 'https://accounts.google.com/gsi/client';
                script.onload = initGoogleAuth;
                document.head.appendChild(script);
            } else {
                initGoogleAuth();
            }
        }

        function initGoogleAuth() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (response) => {
                    if (response.error) {
                        showToast('‚ùå Erreur connexion Google Drive');
                        return;
                    }
                    accessToken = response.access_token;
                    showToast('‚úÖ Connect√© √† Google Drive !');
                    sessionStorage.setItem('gdriveToken', accessToken);
                }
            });
            
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        // V√©rifier si d√©j√† connect√© au chargement
        window.addEventListener('DOMContentLoaded', () => {
            const savedToken = sessionStorage.getItem('gdriveToken');
            if (savedToken) {
                accessToken = savedToken;
            }
        });

        // ============================================
        // UPLOAD VERS GOOGLE DRIVE
        // ============================================

        async function uploadToGoogleDrive(blob, fileName) {
            if (!accessToken) {
                showToast('‚ö†Ô∏è Non connect√© √† Google Drive');
                return;
            }

            try {
                // Cr√©er les m√©tadonn√©es du fichier
                const metadata = {
                    name: fileName,
                    mimeType: 'application/pdf',
                    parents: [DRIVE_FOLDER_ID]
                };

                // Cr√©er le FormData avec m√©tadonn√©es et fichier
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                // Upload multipart
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: form
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast('üéâ PDF upload√© sur Google Drive !');
                    console.log('Fichier upload√©:', result);
                    
                    // Afficher le lien Drive
                    const driveUrl = `https://drive.google.com/file/d/${result.id}/view`;
                    setTimeout(() => {
                        if (confirm('PDF upload√© avec succ√®s ! Voulez-vous l\'ouvrir dans Drive ?')) {
                            window.open(driveUrl, '_blank');
                        }
                    }, 1000);
                } else {
                    const error = await response.json();
                    console.error('Erreur upload:', error);
                    showToast('‚ùå Erreur upload Drive. PDF t√©l√©charg√© en local.');
                }
            } catch (error) {
                console.error('Erreur upload Drive:', error);
                showToast('‚ùå Erreur upload Drive. PDF t√©l√©charg√© en local.');
            }
        }

        // Partage
        function shareForm() {
            if (navigator.share) {
                const formData = new FormData(document.getElementById('rexForm'));
                let text = 'REX Chantier ielo\n\n';
                
                for (let [key, value] of formData.entries()) {
                    if (value) text += `${key}: ${value}\n`;
                }
                
                navigator.share({
                    title: 'REX Chantier',
                    text: text
                }).catch(() => {});
            } else {
                showToast('‚ÑπÔ∏è Partage non disponible');
            }
        }

        // Toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Fermer autocomplete en cliquant ailleurs
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.location-container')) {
                document.getElementById('autocompleteResults').classList.remove('show');
            }
        });

        // Initialisation
        updateProgress();
        document.getElementById('date').valueAsDate = new Date();
    </script>
</body>
</html>
