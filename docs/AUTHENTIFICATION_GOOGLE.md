# üîê Authentification Google OAuth - Guide complet

## üéØ Objectif

Restreindre l'acc√®s au formulaire aux seuls utilisateurs autoris√©s avec un compte Google (@ielo.fr).

## ‚öôÔ∏è Configuration Google Cloud (15 minutes)

### √âtape 1 : Cr√©er un projet Google Cloud

1. Allez sur https://console.cloud.google.com
2. Cliquez sur "S√©lectionner un projet" ‚Üí "Nouveau projet"
3. Nom du projet : `Formulaire REX ielo`
4. Cliquez sur "Cr√©er"

### √âtape 2 : Activer l'API Google Sign-In

1. Dans le menu, allez sur "APIs & Services" ‚Üí "Library"
2. Recherchez "Google+ API" ou "Google Identity"
3. Cliquez sur "Enable"

### √âtape 3 : Configurer l'√©cran de consentement OAuth

1. Menu ‚Üí "APIs & Services" ‚Üí "OAuth consent screen"
2. Type : **Internal** (si vous avez Google Workspace)
   - Ou **External** (si compte Google standard)
3. Remplissez :
   - **App name** : Formulaire REX Chantiers ielo
   - **User support email** : votre email
   - **Developer contact** : votre email
4. Cliquez "Save and Continue"
5. Scopes : Laissez par d√©faut
6. Cliquez "Save and Continue"

### √âtape 4 : Cr√©er des identifiants OAuth 2.0

1. Menu ‚Üí "APIs & Services" ‚Üí "Credentials"
2. Cliquez "Create Credentials" ‚Üí "OAuth client ID"
3. Type d'application : **Application Web**
4. Nom : `Formulaire REX Web`
5. **Origines JavaScript autoris√©es** :
   ```
   https://nrielo.github.io
   ```
6. **URI de redirection autoris√©s** :
   ```
   https://nrielo.github.io/Formulaire_intervention_chantier/
   ```
7. Cliquez "Create"

### √âtape 5 : R√©cup√©rer l'ID client

Vous obtiendrez un **Client ID** qui ressemble √† :
```
123456789-abcdefghijklmnop.apps.googleusercontent.com
```

‚ö†Ô∏è **Copiez-le, vous en aurez besoin !**

## üíª Code √† ajouter au formulaire

### 1. Ajouter le script Google dans le `<head>`

```html
<script src="https://accounts.google.com/gsi/client" async defer></script>
```

### 2. Remplacer la section d'authentification

Remplacez tout le code entre `<div id="loginScreen">` et `</div>` par :

```html
<div id="loginScreen">
    <div class="login-box">
        <div class="login-logo">üåæ</div>
        <h1 class="login-title">REX Chantier ielo</h1>
        <p class="login-subtitle">Connexion avec Google</p>
        
        <div id="g_id_onload"
             data-client_id="VOTRE_CLIENT_ID.apps.googleusercontent.com"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        
        <div class="g_id_signin"
             data-type="standard"
             data-size="large"
             data-theme="outline"
             data-text="sign_in_with"
             data-shape="rectangular"
             data-logo_alignment="left">
        </div>
        
        <div id="loginError" class="login-error"></div>
        
        <div class="login-info">
            üîí Acc√®s r√©serv√© aux collaborateurs ielo<br>
            Connectez-vous avec votre compte Google @ielo.fr
        </div>
    </div>
</div>
```

### 3. Remplacer le JavaScript d'authentification

```javascript
// ============================================
// AUTHENTIFICATION GOOGLE
// ============================================

// Liste des emails autoris√©s (optionnel)
const AUTHORIZED_EMAILS = [
    'user1@ielo.fr',
    'user2@ielo.fr',
    'admin@ielo.fr'
    // Ajoutez les emails autoris√©s ici
];

// Ou autorisez tous les emails d'un domaine
const AUTHORIZED_DOMAIN = '@ielo.fr';

function handleCredentialResponse(response) {
    // D√©coder le JWT token
    const responsePayload = parseJwt(response.credential);
    
    const email = responsePayload.email;
    const name = responsePayload.name;
    const picture = responsePayload.picture;
    
    console.log('Utilisateur connect√©:', name, email);
    
    // V√©rifier si l'email est autoris√©
    const isAuthorized = checkAuthorization(email);
    
    if (isAuthorized) {
        // Authentification r√©ussie
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainContent').classList.add('visible');
        
        // Sauvegarder les infos utilisateur
        sessionStorage.setItem('authenticated', 'true');
        sessionStorage.setItem('userEmail', email);
        sessionStorage.setItem('userName', name);
        sessionStorage.setItem('userPicture', picture);
        
        // Afficher un message de bienvenue
        showToast(`üëã Bienvenue ${name} !`);
        
        // Initialiser le formulaire
        updateProgress();
        document.getElementById('date').valueAsDate = new Date();
        
        // Logger la connexion (optionnel)
        logAccess(name, email);
    } else {
        // Email non autoris√©
        const error = document.getElementById('loginError');
        error.textContent = `‚ùå Acc√®s refus√©. L'email ${email} n'est pas autoris√©.`;
        error.classList.add('show');
    }
}

function checkAuthorization(email) {
    // M√©thode 1 : V√©rifier si l'email est dans la liste
    if (AUTHORIZED_EMAILS.length > 0) {
        return AUTHORIZED_EMAILS.includes(email);
    }
    
    // M√©thode 2 : V√©rifier le domaine
    if (AUTHORIZED_DOMAIN) {
        return email.endsWith(AUTHORIZED_DOMAIN);
    }
    
    // Par d√©faut : refuser
    return false;
}

function parseJwt(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
}

function logAccess(name, email) {
    // Vous pouvez logger les acc√®s dans un service externe
    // Par exemple : Google Analytics, un webhook, etc.
    console.log(`[${new Date().toISOString()}] Acc√®s de ${name} (${email})`);
    
    // Exemple d'envoi vers un webhook (optionnel)
    /*
    fetch('https://votre-webhook.com/log', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            timestamp: new Date().toISOString(),
            user: name,
            email: email,
            action: 'login'
        })
    });
    */
}

// V√©rifier si d√©j√† authentifi√©
window.addEventListener('DOMContentLoaded', () => {
    if (sessionStorage.getItem('authenticated') === 'true') {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainContent').classList.add('visible');
        updateProgress();
        document.getElementById('date').valueAsDate = new Date();
        
        const userName = sessionStorage.getItem('userName');
        if (userName) {
            showToast(`üëã Bon retour ${userName} !`);
        }
    }
});

// Bouton de d√©connexion (optionnel)
function logout() {
    sessionStorage.clear();
    location.reload();
}
```

### 4. Ajouter un bouton de d√©connexion (optionnel)

Dans le header du formulaire, ajoutez :

```html
<div class="header">
    <h1>üåæ REX Chantier</h1>
    <div class="header-subtitle">
        Retour d'exp√©rience - ielo
        <button onclick="logout()" style="float: right; background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
            üö™ D√©connexion
        </button>
    </div>
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>
</div>
```

## üé® Personnalisation du bouton Google

Vous pouvez personnaliser l'apparence du bouton en modifiant les attributs `data-*` :

```html
<div class="g_id_signin"
     data-type="standard"          <!-- standard, icon -->
     data-size="large"              <!-- large, medium, small -->
     data-theme="outline"           <!-- outline, filled_blue, filled_black -->
     data-text="sign_in_with"       <!-- signin_with, signup_with, continue_with, signin -->
     data-shape="rectangular"       <!-- rectangular, pill, circle, square -->
     data-logo_alignment="left">    <!-- left, center -->
</div>
```

## üîí S√©curit√© avanc√©e

### Restriction par domaine email

Pour autoriser uniquement les emails @ielo.fr :

```javascript
const AUTHORIZED_DOMAIN = '@ielo.fr';

function checkAuthorization(email) {
    return email.endsWith(AUTHORIZED_DOMAIN);
}
```

### Liste blanche d'emails

Pour autoriser uniquement certains emails :

```javascript
const AUTHORIZED_EMAILS = [
    'john.doe@ielo.fr',
    'jane.smith@ielo.fr',
    'admin@ielo.fr'
];

function checkAuthorization(email) {
    return AUTHORIZED_EMAILS.includes(email);
}
```

### Combinaison des deux

```javascript
function checkAuthorization(email) {
    // V√©rifier d'abord la liste blanche
    if (AUTHORIZED_EMAILS.includes(email)) return true;
    
    // Sinon v√©rifier le domaine
    if (email.endsWith(AUTHORIZED_DOMAIN)) return true;
    
    return false;
}
```

## üìä Logs d'acc√®s

### Option 1 : Console du navigateur (simple)

D√©j√† impl√©ment√© dans le code ci-dessus.

### Option 2 : Google Analytics (recommand√©)

```javascript
function logAccess(name, email) {
    gtag('event', 'login', {
        'event_category': 'authentication',
        'event_label': email,
        'value': 1
    });
}
```

### Option 3 : Webhook externe

```javascript
function logAccess(name, email) {
    fetch('https://hooks.zapier.com/hooks/catch/XXXXX/YYYYY/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            timestamp: new Date().toISOString(),
            user: name,
            email: email,
            action: 'formulaire_access'
        })
    });
}
```

### Option 4 : Google Sheets (via Apps Script)

Cr√©ez un Google Apps Script qui re√ßoit les logs et les √©crit dans un Sheet.

## üß™ Tester l'authentification

### En local (ne fonctionnera pas)

L'authentification Google n√©cessite HTTPS et un domaine autoris√©.

### Sur GitHub Pages (fonctionne)

1. D√©ployez sur GitHub Pages
2. Ajoutez l'URL dans Google Cloud Console
3. Testez avec votre compte Google

### Test de la liste blanche

1. Connectez-vous avec un email autoris√© ‚Üí ‚úÖ Acc√®s
2. Connectez-vous avec un email non autoris√© ‚Üí ‚ùå Refus

## üí° Avantages de Google OAuth

| Avantage | Description |
|----------|-------------|
| üîê S√©curis√© | Pas de mot de passe √† g√©rer |
| üë§ Identification | Vous savez qui acc√®de au formulaire |
| üìä Tra√ßabilit√© | Logs automatiques des acc√®s |
| üöÄ Simple | Connexion en 1 clic |
| üîÑ SSO | Si vous utilisez Google Workspace |
| ‚ö° Rapide | Pas besoin de cr√©er de compte |

## ‚ö†Ô∏è Limitations

- N√©cessite une connexion Internet
- N√©cessite un compte Google
- Configuration initiale plus complexe
- D√©pendance √† Google

## üÜö Comparaison des m√©thodes

| Crit√®re | Mot de passe simple | Google OAuth |
|---------|---------------------|--------------|
| S√©curit√© | ‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
| Simplicit√© | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê |
| Tra√ßabilit√© | ‚ùå | ‚úÖ |
| Co√ªt | Gratuit | Gratuit |
| Configuration | 2 min | 15 min |
| Maintenance | Faible | Aucune |

## üéØ Recommandation

**Pour d√©marrer rapidement :** Utilisez le mot de passe simple (d√©j√† fait)

**Pour la production :** Impl√©mentez Google OAuth selon ce guide

**Id√©al :** Commencez avec mot de passe, puis migrez vers OAuth quand vous √™tes pr√™t

## üìû Besoin d'aide ?

Si vous voulez impl√©menter Google OAuth, je peux :
1. Cr√©er le code complet
2. Vous guider dans la configuration Google Cloud
3. Tester avec vous

Voulez-vous que je cr√©e une version compl√®te avec Google OAuth ?
